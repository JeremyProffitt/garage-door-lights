AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Particle Argon Candle Lights Control System

Parameters:
  DomainName:
    Type: String
    Default: lights.jeremy.ninja
    Description: Domain name for the website
  HostedZoneId:
    Type: String
    Description: Route53 Hosted Zone ID for the domain
  CertificateArn:
    Type: String
    Description: ACM Certificate ARN for the custom domain
  AlexaSkillId:
    Type: String
    Default: "amzn1.ask.skill.placeholder"
    Description: Alexa Smart Home Skill ID (required for Alexa integration)
  AlexaClientId:
    Type: String
    Default: "garage-lights-alexa"
    Description: OAuth Client ID for Alexa account linking
  AlexaClientSecret:
    Type: String
    Default: ""
    NoEcho: true
    Description: OAuth Client Secret for Alexa account linking
  ClaudeApiKey:
    Type: String
    Default: ""
    NoEcho: true
    Description: Anthropic Claude API key for Glow Blaster AI

Conditions:
  HasAlexaSkillId: !Not [!Equals [!Ref AlexaSkillId, "amzn1.ask.skill.placeholder"]]

Globals:
  Function:
    Runtime: provided.al2
    Architectures:
      - x86_64
    Timeout: 30
    Environment:
      Variables:
        USERS_TABLE: !Ref UsersTable
        PATTERNS_TABLE: !Ref PatternsTable
        DEVICES_TABLE: !Ref DevicesTable
        SESSIONS_TABLE: !Ref SessionsTable
        DOMAIN_NAME: !Ref DomainName
        ALEXA_TOKENS_TABLE: !Ref AlexaTokensTable
        ALEXA_CODES_TABLE: !Ref AlexaCodesTable
        ALEXA_STATE_TABLE: !Ref AlexaStateTable
        ALEXA_SKILL_ID: !Ref AlexaSkillId
        ALEXA_CLIENT_ID: !Ref AlexaClientId
        ALEXA_CLIENT_SECRET: !Ref AlexaClientSecret
        CONVERSATIONS_TABLE: !Ref ConversationsTable
        CLAUDE_API_KEY: !Ref ClaudeApiKey

Resources:
  # DynamoDB Tables
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-users
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: username
          AttributeType: S
      KeySchema:
        - AttributeName: username
          KeyType: HASH
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES

  PatternsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-patterns
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: patternId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: patternId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  DevicesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-devices
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: deviceId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: deviceId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  SessionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-sessions
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: sessionId
          AttributeType: S
        - AttributeName: username
          AttributeType: S
      KeySchema:
        - AttributeName: sessionId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: username-index
          KeySchema:
            - AttributeName: username
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  # Alexa Integration DynamoDB Tables
  AlexaTokensTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-alexa-tokens
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: tokenHash
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: tokenHash
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  AlexaCodesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-alexa-codes
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: code
          AttributeType: S
      KeySchema:
        - AttributeName: code
          KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  AlexaStateTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-alexa-state
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: endpointId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: endpointId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  # Glow Blaster Conversations Table
  ConversationsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub ${AWS::StackName}-conversations
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: conversationId
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: conversationId
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: userId-index
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expiresAt
        Enabled: true

  # CloudWatch Log Groups with retention
  AuthFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-AuthFunction'
      RetentionInDays: 7

  PatternsFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-PatternsFunction'
      RetentionInDays: 7

  DevicesFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-DevicesFunction'
      RetentionInDays: 7

  ParticleFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-ParticleFunction'
      RetentionInDays: 7

  FrontendFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-FrontendFunction'
      RetentionInDays: 7

  OAuthFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-OAuthFunction'
      RetentionInDays: 7

  AlexaFunctionLogGroup:
    Condition: HasAlexaSkillId
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-AlexaFunction'
      RetentionInDays: 7

  GlowBlasterFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/lambda/${AWS::StackName}-GlowBlasterFunction'
      RetentionInDays: 7

  # Lambda Functions
  AuthFunction:
    DependsOn: AuthFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: backend/functions/auth/
      Handler: bootstrap
      MemorySize: 1024
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref SessionsTable
      Events:
        Login:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/auth/login
            Method: POST
        Register:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/auth/register
            Method: POST
        Validate:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/auth/validate
            Method: POST
        UpdateParticleSettings:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/settings/particle
            Method: POST

  PatternsFunction:
    DependsOn: PatternsFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: backend/functions/patterns/
      Handler: bootstrap
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref PatternsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
      Events:
        Effects:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/effects
            Method: GET
        List:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/patterns
            Method: GET
        Create:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/patterns
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/patterns/{patternId}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/patterns/{patternId}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/patterns/{patternId}
            Method: DELETE

  DevicesFunction:
    DependsOn: DevicesFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: backend/functions/devices/
      Handler: bootstrap
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DevicesTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref PatternsTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
      Events:
        List:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/devices
            Method: GET
        Register:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/devices
            Method: POST
        Get:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/devices/{deviceId}
            Method: GET
        Update:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/devices/{deviceId}
            Method: PUT
        Delete:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/devices/{deviceId}
            Method: DELETE
        AssignPattern:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/devices/{deviceId}/pattern
            Method: PUT

  ParticleFunction:
    DependsOn: ParticleFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: backend/functions/particle/
      Handler: bootstrap
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref DevicesTable
        - DynamoDBReadPolicy:
            TableName: !Ref PatternsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
      Events:
        SendCommand:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/particle/command
            Method: POST
        GetDeviceInfo:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/particle/device/{deviceId}
            Method: GET
        RefreshDevices:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/particle/devices/refresh
            Method: POST
        ValidateToken:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/particle/validate-token
            Method: POST
        OAuthInitiate:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/particle/oauth/initiate
            Method: POST

  # GlowBlaster Lambda for AI Pattern Creation
  GlowBlasterFunction:
    DependsOn: GlowBlasterFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: backend/functions/glowblaster/
      Handler: bootstrap
      Timeout: 60
      MemorySize: 256
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ConversationsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref PatternsTable
        - DynamoDBReadPolicy:
            TableName: !Ref SessionsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        ListConversations:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/conversations
            Method: GET
        CreateConversation:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/conversations
            Method: POST
        GetConversation:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/conversations/{conversationId}
            Method: GET
        DeleteConversation:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/conversations/{conversationId}
            Method: DELETE
        Chat:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/conversations/{conversationId}/chat
            Method: POST
        Compact:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/conversations/{conversationId}/compact
            Method: POST
        Compile:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/compile
            Method: POST
        ListPatterns:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/patterns
            Method: GET
        SavePattern:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/patterns
            Method: POST
        UpdatePattern:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/patterns/{patternId}
            Method: PUT
        DeletePattern:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /api/glowblaster/patterns/{patternId}
            Method: DELETE

  # OAuth Lambda for Alexa Account Linking
  OAuthFunction:
    DependsOn: OAuthFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: backend/functions/oauth/
      Handler: bootstrap
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AlexaTokensTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AlexaCodesTable
      Events:
        AuthorizeGet:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /oauth/authorize
            Method: GET
        AuthorizePost:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /oauth/authorize
            Method: POST
        Token:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /oauth/token
            Method: POST

  # Alexa Smart Home Skill Handler
  AlexaFunction:
    Condition: HasAlexaSkillId
    DependsOn: AlexaFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: backend/functions/alexa/
      Handler: bootstrap
      MemorySize: 256
      Timeout: 10
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref DevicesTable
        - DynamoDBReadPolicy:
            TableName: !Ref AlexaTokensTable
        - DynamoDBCrudPolicy:
            TableName: !Ref AlexaStateTable
      Events:
        AlexaSmartHome:
          Type: AlexaSkill
          Properties:
            SkillId: !Ref AlexaSkillId

  # Frontend Lambda (Go Fiber)
  FrontendFunction:
    DependsOn: FrontendFunctionLogGroup
    Type: AWS::Serverless::Function
    Metadata:
      BuildMethod: makefile
    Properties:
      CodeUri: frontend/
      Handler: bootstrap
      MemorySize: 512
      Timeout: 30
      Environment:
        Variables:
          API_ENDPOINT: !Sub https://${DomainName}
      Policies:
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:Query
              Resource:
                - !GetAtt UsersTable.Arn
                - !GetAtt SessionsTable.Arn
      Events:
        Root:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /
            Method: ANY
        Proxy:
          Type: Api
          Properties:
            RestApiId: !Ref WebsiteGateway
            Path: /{proxy+}
            Method: ANY

  WebsiteGateway:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub ${AWS::StackName}-website
      StageName: prod
      BinaryMediaTypes:
        - "image/*"
        - "application/octet-stream"
        - "application/pdf"
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      Domain:
        DomainName: !Ref DomainName
        CertificateArn: !Ref CertificateArn
        EndpointConfiguration: REGIONAL
        Route53:
          HostedZoneId: !Ref HostedZoneId

Outputs:
  WebsiteUrl:
    Description: Website URL (API available at /api)
    Value: !Sub https://${DomainName}
  UsersTableName:
    Description: Users DynamoDB table name
    Value: !Ref UsersTable
  PatternsTableName:
    Description: Patterns DynamoDB table name
    Value: !Ref PatternsTable
  DevicesTableName:
    Description: Devices DynamoDB table name
    Value: !Ref DevicesTable
  SessionsTableName:
    Description: Sessions DynamoDB table name
    Value: !Ref SessionsTable
  AlexaTokensTableName:
    Description: Alexa Tokens DynamoDB table name
    Value: !Ref AlexaTokensTable
  AlexaCodesTableName:
    Description: Alexa Auth Codes DynamoDB table name
    Value: !Ref AlexaCodesTable
  AlexaStateTableName:
    Description: Alexa Device State DynamoDB table name
    Value: !Ref AlexaStateTable
  ConversationsTableName:
    Description: Glow Blaster Conversations DynamoDB table name
    Value: !Ref ConversationsTable
  AlexaFunctionArn:
    Condition: HasAlexaSkillId
    Description: ARN of the Alexa Smart Home Lambda function
    Value: !GetAtt AlexaFunction.Arn
  OAuthAuthorizeUrl:
    Description: OAuth Authorization URL for Alexa account linking
    Value: !Sub https://${DomainName}/oauth/authorize
  OAuthTokenUrl:
    Description: OAuth Token URL for Alexa account linking
    Value: !Sub https://${DomainName}/oauth/token
