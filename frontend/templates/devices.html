<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devices - Candle Lights Controller</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/led-simulator.js"></script>
    <script src="/static/js/notifications.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand"><a href="/dashboard" style="color: inherit; text-decoration: none;">üïØÔ∏è Candle Lights</a></div>
        <div class="nav-menu">
            <a href="/dashboard">Dashboard</a>
            <a href="/patterns">Patterns</a>
            <a href="/glowblaster">Glow Blaster</a>
            <a href="/devices" class="active">Devices</a>
            <a href="/settings">Settings</a>
            <a href="/auth/logout">Logout</a>
        </div>
    </nav>

    <div class="container" x-data="devicesPage()">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="color: white;">Your Devices (<span x-text="deviceCount"></span><span x-show="hiddenDeviceCount > 0" style="opacity: 0.7;"> + <span x-text="hiddenDeviceCount"></span> hidden</span>)</h1>
            <label style="color: white; cursor: pointer;">
                <input type="checkbox" x-model="showHidden"> Show Hidden Devices
            </label>
        </div>

        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-direction: column;">
            <div style="display: flex; gap: 1rem;">
                <button @click="refreshFromParticle()" class="btn btn-primary" :disabled="isRefreshing">
                    <span x-show="!isRefreshing">üîÑ Refresh from Particle.io</span>
                    <span x-show="isRefreshing">üîÑ Refreshing...</span>
                </button>
            </div>
            <div x-show="refreshMessage" style="color: white; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;" x-text="refreshMessage"></div>
        </div>

        <div x-show="filteredDevices.length === 0 && !isLoading" style="color: white; margin-top: 2rem; font-size: 1.1rem;">
            <p>No devices registered yet. Click "Refresh from Particle.io" to import your Particle devices!</p>
        </div>

        <div x-show="isLoading" style="color: white; margin-top: 2rem; font-size: 1.1rem;">
            <p>Loading devices...</p>
        </div>

        <!-- Ready to Configure Section -->
        <div x-show="readyDevices.length > 0 && !isLoading">
            <h2 style="color: #10b981; margin: 1.5rem 0 1rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="width: 10px; height: 10px; background: #10b981; border-radius: 50%; display: inline-block;"></span>
                Ready to Configure (<span x-text="readyDevices.length"></span>)
            </h2>
            <div class="devices-grid">
                <template x-for="device in readyDevices" :key="device.deviceId">
                    <div class="card device-card" :style="device.isHidden ? 'opacity: 0.6' : ''" style="border-left: 3px solid #10b981;">
                        <div class="device-header">
                            <div>
                                <h3 x-text="device.name"></h3>
                                <p style="font-size: 0.85rem; color: #6b7280; margin: 0;">
                                    <span x-text="device.platform || 'Unknown'"></span> <span x-text="device.firmwareVersion || ''"></span>
                                </p>
                            </div>
                            <span class="badge badge-success">Ready</span>
                        </div>
                        <div class="device-strips" x-show="device.ledStrips && device.ledStrips.length > 0" style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 4px;">
                            <p style="font-size: 0.85rem; margin-bottom: 0.5rem;"><strong>LED Strips:</strong></p>
                            <template x-for="(strip, stripIndex) in device.ledStrips" :key="strip.pin">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.1); border-radius: 4px;">
                                    <span style="font-size: 0.8rem; min-width: 80px;">
                                        D<span x-text="strip.pin"></span>: <span x-text="strip.ledCount"></span> LEDs
                                    </span>
                                    <select
                                        @change="setStripPattern(device, stripIndex, $event.target.value)"
                                        style="flex: 1; padding: 0.25rem; font-size: 0.8rem; border-radius: 4px;"
                                        :value="getStripPatternId(device, strip.pin)">
                                        <option value="">-- Select Pattern --</option>
                                        <template x-for="pattern in patterns" :key="pattern.patternId">
                                            <option :value="pattern.patternId" x-text="pattern.name" :selected="getStripPatternId(device, strip.pin) === pattern.patternId"></option>
                                        </template>
                                        <option value="__rainbow_bytecode_test__">Rainbow Bytecode Test</option>
                                    </select>
                                    <button
                                        @click="applyStripPattern(device, strip.pin)"
                                        class="btn btn-sm btn-primary"
                                        style="padding: 0.25rem 0.5rem; font-size: 0.75rem;"
                                        :disabled="!getStripPatternId(device, strip.pin)">
                                        Apply
                                    </button>
                                </div>
                            </template>
                        </div>
                        <div class="buttons">
                            <button @click="openStripConfig(device)" class="btn btn-sm btn-secondary">Configure LEDs</button>
                            <button @click="toggleHidden(device.deviceId, device.isHidden)" class="btn btn-sm" :class="device.isHidden ? 'btn-secondary' : 'btn-danger'">
                                <span x-text="device.isHidden ? 'Unhide' : 'Hide'"></span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Online (Not Ready) Section -->
        <div x-show="onlineDevices.length > 0 && !isLoading">
            <h2 style="color: #f59e0b; margin: 1.5rem 0 1rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="width: 10px; height: 10px; background: #f59e0b; border-radius: 50%; display: inline-block;"></span>
                Online - Needs Firmware (<span x-text="onlineDevices.length"></span>)
            </h2>
            <div class="devices-grid">
                <template x-for="device in onlineDevices" :key="device.deviceId">
                    <div class="card device-card" :style="device.isHidden ? 'opacity: 0.6' : ''" style="border-left: 3px solid #f59e0b;">
                        <div class="device-header">
                            <h3 x-text="device.name"></h3>
                            <span class="badge" style="background: #f59e0b;">Online</span>
                        </div>
                        <div class="device-info">
                            <p><strong>Particle ID:</strong> <span x-text="device.particleId"></span></p>
                            <p><strong>Last Seen:</strong> <span x-text="new Date(device.lastSeen).toLocaleString()"></span></p>
                            <p x-show="device.firmwareVersion" style="color: #6b7280; font-size: 0.9rem;"><strong>Detected Firmware:</strong> <span x-text="device.firmwareVersion"></span></p>
                            <p style="color: #f59e0b; font-size: 0.9rem;">
                                <span x-show="!device.firmwareVersion">Flash the LED controller firmware to enable configuration.</span>
                                <span x-show="device.firmwareVersion">Device has firmware but may need refresh. Click "Refresh from Particle.io" above.</span>
                            </p>
                        </div>
                        <div class="buttons">
                            <button @click="checkDeviceReadiness(device)" class="btn btn-sm btn-primary">Check Status</button>
                            <button @click="toggleHidden(device.deviceId, device.isHidden)" class="btn btn-sm" :class="device.isHidden ? 'btn-secondary' : 'btn-danger'">
                                <span x-text="device.isHidden ? 'Unhide' : 'Hide'"></span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Offline Section -->
        <div x-show="offlineDevices.length > 0 && !isLoading">
            <h2 style="color: #6b7280; margin: 1.5rem 0 1rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                <span style="width: 10px; height: 10px; background: #6b7280; border-radius: 50%; display: inline-block;"></span>
                Offline (<span x-text="offlineDevices.length"></span>)
            </h2>
            <div class="devices-grid">
                <template x-for="device in offlineDevices" :key="device.deviceId">
                    <div class="card device-card" :style="device.isHidden ? 'opacity: 0.6' : ''" style="border-left: 3px solid #6b7280; opacity: 0.7;">
                        <div class="device-header">
                            <h3 x-text="device.name"></h3>
                            <span class="badge badge-danger">Offline</span>
                        </div>
                        <div class="device-info">
                            <p><strong>Particle ID:</strong> <span x-text="device.particleId"></span></p>
                            <p><strong>Last Seen:</strong> <span x-text="new Date(device.lastSeen).toLocaleString()"></span></p>
                        </div>
                        <div class="buttons">
                            <button @click="toggleHidden(device.deviceId, device.isHidden)" class="btn btn-sm" :class="device.isHidden ? 'btn-secondary' : 'btn-danger'">
                                <span x-text="device.isHidden ? 'Unhide' : 'Hide'"></span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- LED Strip Configuration Modal -->
        <div x-show="showStripModal" class="modal" style="display: none;" @click.self="showStripModal = false">
            <div class="modal-content">
                <h2>Configure LED Strips - <span x-text="stripConfigDevice?.name"></span></h2>

                <!-- Device Info Panel -->
                <div x-show="isLoadingVariables" style="padding: 1rem; text-align: center; color: #6b7280;">
                    Loading device information...
                </div>

                <div x-show="!isLoadingVariables && deviceVariables" style="margin-bottom: 1rem; padding: 0.75rem; background: #e0f2fe; border-radius: 8px; border: 1px solid #0ea5e9;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #0369a1;">Device Status</span>
                        <button type="button" @click="syncFromDevice()" class="btn btn-sm" style="background: #0ea5e9; color: white;">
                            Sync from Device
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.85rem; color: #0c4a6e;">
                        <div><strong>Firmware:</strong> <span x-text="deviceVariables?.firmwareVersion || 'Unknown'"></span></div>
                        <div><strong>Platform:</strong> <span x-text="deviceVariables?.platform || 'Unknown'"></span></div>
                        <div><strong>Max Strips:</strong> <span x-text="deviceVariables?.maxStrips || 4"></span></div>
                        <div><strong>Max LEDs/Strip:</strong> <span x-text="deviceVariables?.maxLedsPerStrip || 60"></span></div>
                        <div><strong>Current Strips:</strong> <span x-text="deviceVariables?.numStrips || 0"></span></div>
                        <div x-show="deviceVariables?.stripsRaw"><strong>Config:</strong> <span x-text="deviceVariables?.stripsRaw" style="font-family: monospace;"></span></div>
                    </div>
                </div>

                <div x-show="!isLoadingVariables && !deviceVariables && stripConfigDevice?.isReady" style="margin-bottom: 1rem; padding: 0.75rem; background: #fef3c7; border-radius: 8px; border: 1px solid #f59e0b; color: #92400e; font-size: 0.9rem;">
                    Could not fetch device variables. Device may be offline or busy.
                </div>

                <p style="color: #6b7280; margin-bottom: 1rem;">Configure which pins have RGB LED strips and how many LEDs on each.</p>

                <div style="margin-bottom: 1rem;">
                    <template x-for="(strip, index) in stripConfig" :key="index">
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem; padding: 0.75rem; background: #f3f4f6; border-radius: 8px;">
                            <div style="flex: 1;">
                                <label style="display: block; font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem;">Pin</label>
                                <select x-model.number="strip.pin" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                                    <option value="0">D0</option>
                                    <option value="1">D1</option>
                                    <option value="2">D2</option>
                                    <option value="3">D3</option>
                                    <option value="4">D4</option>
                                    <option value="5">D5</option>
                                    <option value="6">D6</option>
                                    <option value="7">D7</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="display: block; font-size: 0.85rem; color: #374151; margin-bottom: 0.25rem;">LED Count (max <span x-text="getMaxLedsPerStrip()"></span>)</label>
                                <input type="number" x-model.number="strip.ledCount" min="1" :max="getMaxLedsPerStrip()" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            </div>
                            <button type="button" @click="removeStrip(index)" class="btn btn-sm btn-danger" style="margin-top: 1.25rem;">Remove</button>
                        </div>
                    </template>
                </div>

                <div x-show="stripConfig.length === 0" style="text-align: center; padding: 1rem; color: #6b7280;">
                    No LED strips configured. Click "Add Strip" to add one.
                </div>

                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button type="button" @click="addStrip()" class="btn btn-secondary" :disabled="stripConfig.length >= getMaxStrips()">
                        + Add Strip
                    </button>
                    <span x-show="stripConfig.length >= getMaxStrips()" style="color: #6b7280; font-size: 0.85rem; align-self: center;">(Max <span x-text="getMaxStrips()"></span> strips)</span>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button type="button" @click="showStripModal = false" class="btn btn-secondary">Cancel</button>
                    <button type="button" @click="saveStripConfig()" class="btn btn-primary" :disabled="isSavingStrips">
                        <span x-show="!isSavingStrips">Save & Apply to Device</span>
                        <span x-show="isSavingStrips">Saving...</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/devices.js"></script>
</body>
</html>
