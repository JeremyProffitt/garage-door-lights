<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glow Blaster - Candle Lights Controller</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/led-simulator.js"></script>
    <script src="/static/js/wled-preview.js"></script>
    <script src="/static/js/notifications.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand"><a href="/dashboard" style="color: inherit; text-decoration: none;">üïØÔ∏è Candle Lights</a></div>
        <div class="nav-menu">
            <a href="/dashboard">Dashboard</a>
            <a href="/patterns">Patterns</a>
            <a href="/glowblaster" class="active">Glow Blaster</a>
            <a href="/devices">Devices</a>
            <a href="/settings">Settings</a>
            <a href="/logs">Logs</a>
            <a href="/auth/logout">Logout</a>
        </div>
    </nav>

    <div class="container" x-data="glowBlasterPage()" x-init="init()">
        <!-- Header with tagline -->
        <div class="glowblaster-header">
            <h1>Glow Blaster</h1>
            <p class="tagline">Pan Galactic Glowblaster - Wild, colorful bursts that feel slightly irresponsible</p>
        </div>

        <!-- Three-column layout -->
        <div class="glowblaster-layout">
            <!-- Left: Conversation sidebar -->
            <div class="conversation-sidebar">
                <button @click="startNewConversation()" class="btn btn-primary" style="width: 100%; margin-bottom: 0.5rem; padding: 0.5rem; font-size: 0.85rem;">
                    + New Conversation
                </button>

                <!-- Model selector -->
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.75rem; color: #6b7280;">Model</label>
                    <select x-model="selectedModel" @change="updateConversationModel()" style="width: 100%; padding: 0.35rem; border-radius: 6px; border: 1px solid #e5e7eb; font-size: 0.8rem;">
                        <template x-for="model in models" :key="model.id">
                            <option :value="model.id" x-text="model.name"></option>
                        </template>
                    </select>
                </div>

                <h3 style="font-size: 0.8rem; color: #374151; margin-bottom: 0.25rem;">Conversations</h3>
                <div class="conversation-list">
                    <template x-for="conv in conversations" :key="conv.conversationId">
                        <div class="conversation-item"
                             :class="{ active: activeConversation?.conversationId === conv.conversationId }"
                             @click="loadConversation(conv.conversationId)">
                            <span x-text="conv.title" style="display: block; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
                            <small style="color: #9ca3af;" x-text="formatDate(conv.updatedAt)"></small>
                            <button @click.stop="deleteConversation(conv.conversationId)" class="delete-conv-btn" title="Delete">√ó</button>
                        </div>
                    </template>
                    <div x-show="conversations.length === 0" style="color: #9ca3af; font-size: 0.85rem; padding: 0.5rem;">
                        No conversations yet
                    </div>
                </div>

                <!-- Pattern list -->
                <h3 style="font-size: 0.8rem; color: #374151; margin: 0.5rem 0 0.25rem;">Saved Patterns</h3>
                <div class="pattern-list">
                    <template x-for="pattern in glowBlasterPatterns" :key="pattern.patternId">
                        <div class="pattern-item" style="display: flex; justify-content: space-between; align-items: center;">
                            <span @click="loadPatternToConversation(pattern)" x-text="pattern.name" style="font-weight: 500; cursor: pointer; flex: 1;"></span>
                            <button @click.stop="deletePattern(pattern.patternId, pattern.name)"
                                    class="btn-delete-pattern"
                                    title="Delete pattern"
                                    style="background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0.25rem; font-size: 0.8rem;"
                                    @mouseenter="$el.style.color='#ef4444'"
                                    @mouseleave="$el.style.color='#9ca3af'">‚úï</button>
                        </div>
                    </template>
                    <div x-show="glowBlasterPatterns.length === 0" style="color: #9ca3af; font-size: 0.85rem; padding: 0.5rem;">
                        No patterns saved yet
                    </div>
                </div>
            </div>

            <!-- Center: Chat interface -->
            <div class="chat-container">
                <!-- Chat Header with Actions -->
                <div class="chat-header" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #e5e7eb; background: #fff;">
                    <div style="font-weight: 500; color: #374151;" x-text="activeConversation ? activeConversation.title : 'New Conversation'"></div>
                    <div style="display: flex; gap: 0.5rem;" x-show="activeConversation">
                        <button @click="viewPrompt()" class="btn btn-sm" style="background: #f3f4f6; color: #4b5563;" title="View Prompt (Debug)" x-show="lastDebugInfo">
                            <span style="font-size: 1.1em;">üêõ</span>
                        </button>
                        <button @click="viewConversation()" class="btn btn-sm" style="background: #f3f4f6; color: #4b5563;" title="View Conversation Data">
                            <span style="font-size: 1.1em;">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>

                <div class="chat-messages" x-ref="chatMessages">
                    <!-- Welcome message -->
                    <div x-show="currentMessages.length === 0" class="chat-welcome">
                        <h3>Welcome to Glow Blaster!</h3>
                        <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">Describe the LED pattern you want:</p>
                        <ul style="font-size: 0.85rem;">
                            <li>"Cozy campfire with tall orange flames"</li>
                            <li>"Pulsing blue wave"</li>
                            <li>"Sparkly and magical"</li>
                        </ul>
                    </div>

                    <template x-for="(msg, idx) in currentMessages" :key="idx">
                        <div class="chat-message" :class="msg.role">
                            <div class="message-content" x-html="formatMessage(msg.content)"></div>
                        </div>
                    </template>

                    <div x-show="isLoading" class="chat-message assistant loading">
                        <div class="typing-indicator">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>

                <div class="chat-input-area">
                    <textarea
                        x-model="userMessage"
                        @keydown.enter.prevent="if (!$event.shiftKey) sendMessage()"
                        placeholder="Describe the pattern..."
                        rows="2"
                        :disabled="isLoading"></textarea>
                    <button @click="sendMessage()" class="btn btn-primary" :disabled="isLoading || !userMessage.trim()">
                        <span x-show="!isLoading">Send</span>
                        <span x-show="isLoading">...</span>
                    </button>
                </div>

                <!-- Action buttons -->
                <div class="chat-actions" x-show="currentWLED" style="padding: 0.5rem; gap: 0.5rem;">
                    <template x-if="editingPatternId">
                        <button @click="updateExistingPattern()" class="btn btn-secondary btn-sm" x-text="'Save ' + editingPatternName"></button>
                    </template>
                    <button @click="saveAsNewPattern()" class="btn btn-secondary btn-sm">Save as New Pattern</button>
                    <button @click="showDeviceModal = true" class="btn btn-primary btn-sm">Send to Device</button>
                    <button @click="compactConversation()" class="btn btn-sm" style="background: #e5e7eb; color: #374151;">Compact</button>
                </div>
            </div>

            <!-- Right: Live preview -->
            <div class="preview-panel">
                <h3>Live Preview</h3>
                <div id="glowblasterPreview" class="led-preview-large">
                    <div class="no-preview" x-show="!currentWLED">
                        <p>Pattern preview will appear here</p>
                    </div>
                </div>

                <div x-show="currentWLED" class="wled-display" style="margin-top: 1rem;">
                    <h4 style="margin-bottom: 0.5rem; font-size: 0.9rem; color: #374151;">GlowBlaster JSON</h4>
                    <pre x-text="formatWLEDDisplay(currentWLED)" style="max-height: 200px; overflow-y: auto; background: #1f2937; color: #e5e7eb; padding: 0.75rem; border-radius: 8px; font-size: 0.75rem; margin: 0;"></pre>
                </div>

                <div class="token-usage" x-show="totalTokens > 0">
                    <small>Tokens used: <span x-text="totalTokens.toLocaleString()"></span></small>
                </div>
            </div>
        </div>

        <!-- Device Selection Modal -->
        <div x-show="showDeviceModal" class="modal" style="display: none;" @click.self="showDeviceModal = false">
            <div class="modal-content" style="max-width: 400px;">
                <h2>Send to Device</h2>
                <p style="color: #6b7280; margin-bottom: 1rem;">Select a device and LED strip to apply this pattern.</p>

                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Device</label>
                    <select x-model="selectedDeviceId" @change="onDeviceSelect()" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <option value="">Select a device...</option>
                        <template x-for="device in devices" :key="device.deviceId">
                            <option :value="device.deviceId" x-text="device.name"></option>
                        </template>
                    </select>
                </div>

                <div style="margin-bottom: 1rem;" x-show="selectedDevice?.ledStrips?.length > 0">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">LED Strip</label>
                    <select x-model="selectedStripPin" style="width: 100%; padding: 0.75rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <template x-for="strip in selectedDevice?.ledStrips || []" :key="strip.pin">
                            <option :value="strip.pin" x-text="'D' + strip.pin + ' (' + strip.ledCount + ' LEDs)'"></option>
                        </template>
                    </select>
                </div>

                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                    <button @click="showDeviceModal = false" class="btn btn-secondary">Cancel</button>
                    <button @click="sendToDevice()" class="btn btn-primary" :disabled="!selectedDeviceId">Send</button>
                </div>
            </div>
        </div>
        <!-- View Conversation Modal -->
        <div x-show="showViewModal" class="modal" style="display: none;" @click.self="showViewModal = false">
            <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h2>Conversation Data</h2>
                    <button @click="showViewModal = false" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <!-- Format Toggle -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.5rem; background: #f3f4f6; border-radius: 8px;">
                    <button @click="conversationViewMode = 'readable'"
                            class="btn btn-sm"
                            :class="conversationViewMode === 'readable' ? 'btn-primary' : 'btn-secondary'"
                            style="flex: 1;">Human Readable</button>
                    <button @click="conversationViewMode = 'raw'"
                            class="btn btn-sm"
                            :class="conversationViewMode === 'raw' ? 'btn-primary' : 'btn-secondary'"
                            style="flex: 1;">Raw JSON</button>
                </div>
                <div style="flex: 1; overflow: auto; background: #f9fafb; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <template x-if="conversationViewMode === 'raw'">
                        <pre x-text="conversationJson" style="margin: 0; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; word-break: break-all;"></pre>
                    </template>
                    <template x-if="conversationViewMode === 'readable'">
                        <div x-html="conversationReadable" style="font-size: 0.9rem;"></div>
                    </template>
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                    <button @click="copyCurrentConversationView()" class="btn btn-secondary">Copy to Clipboard</button>
                    <button @click="downloadCurrentConversationView()" class="btn btn-secondary">Download</button>
                    <button @click="showViewModal = false" class="btn btn-primary">Close</button>
                </div>
            </div>
        </div>
        <!-- View Prompt Modal -->
        <div x-show="showPromptModal" class="modal" style="display: none;" @click.self="showPromptModal = false">
            <div class="modal-content" style="max-width: 800px; height: 80vh; display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <h2>Last Prompt (Debug)</h2>
                    <button @click="showPromptModal = false" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <!-- Format Toggle -->
                <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.5rem; background: #f3f4f6; border-radius: 8px;">
                    <button @click="promptViewMode = 'readable'"
                            class="btn btn-sm"
                            :class="promptViewMode === 'readable' ? 'btn-primary' : 'btn-secondary'"
                            style="flex: 1;">Human Readable</button>
                    <button @click="promptViewMode = 'raw'"
                            class="btn btn-sm"
                            :class="promptViewMode === 'raw' ? 'btn-primary' : 'btn-secondary'"
                            style="flex: 1;">Raw JSON</button>
                </div>
                <div style="flex: 1; overflow: auto; background: #f9fafb; padding: 1rem; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <template x-if="promptViewMode === 'raw'">
                        <pre x-text="promptJson" style="margin: 0; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; word-break: break-all;"></pre>
                    </template>
                    <template x-if="promptViewMode === 'readable'">
                        <div x-html="promptReadable" style="font-size: 0.9rem;"></div>
                    </template>
                </div>
                <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1rem;">
                    <button @click="copyCurrentPromptView()" class="btn btn-secondary">Copy to Clipboard</button>
                    <button @click="downloadCurrentPromptView()" class="btn btn-secondary">Download</button>
                    <button @click="showPromptModal = false" class="btn btn-primary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/glowblaster.js"></script>
</body>
</html>
