<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Candle Lights Controller</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">üïØÔ∏è Candle Lights</div>
        <div class="nav-menu">
            <a href="/dashboard" class="active">Dashboard</a>
            <a href="/patterns">Patterns</a>
            <a href="/devices">Devices</a>
            <a href="/settings">Settings</a>
            <a href="/auth/logout">Logout</a>
        </div>
    </nav>

    <div class="container">
        <h1 style="color: white;">Welcome, {{.Username}}!</h1>

        <div class="dashboard-grid" x-data="dashboard()">
            <div class="card">
                <h2>Particle.io Connection</h2>
                <div x-show="particleStatus === 'checking'" style="color: #6b7280;">
                    <p>Checking connection...</p>
                </div>
                <div x-show="particleStatus === 'connected'" style="color: #10b981;">
                    <p>‚úì Connected to Particle.io</p>
                </div>
                <div x-show="particleStatus === 'error'" style="color: #ef4444;">
                    <p>‚úó Not connected to Particle.io</p>
                    <a href="/settings" class="btn btn-secondary" style="margin-top: 10px;">Go to Settings</a>
                </div>
            </div>

            <div class="card">
                <h2>Quick Actions</h2>
                <div class="buttons">
                    <a href="/patterns" class="btn btn-primary">Create Pattern</a>
                    <a href="/devices" class="btn btn-secondary">Add Device</a>
                </div>
            </div>

            <div class="card">
                <h2>Your Devices</h2>
                <div id="devicesList">
                    <p style="color: #6b7280;">Loading devices...</p>
                </div>
            </div>

            <div class="card">
                <h2>Recent Patterns</h2>
                <div id="patternsList">
                    <p style="color: #6b7280;">Loading patterns...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        function dashboard() {
            return {
                devices: [],
                patterns: [],
                particleStatus: 'checking',
                init() {
                    this.checkParticleConnection();
                    this.loadDevices();
                    this.loadPatterns();
                },
                async checkParticleConnection() {
                    try {
                        const resp = await fetch('/api/particle/devices/refresh', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'}
                        });
                        const data = await resp.json();
                        if (data.success) {
                            this.particleStatus = 'connected';
                        } else {
                            this.particleStatus = 'error';
                        }
                    } catch (err) {
                        this.particleStatus = 'error';
                    }
                },
                async loadDevices() {
                    try {
                        const resp = await fetch('/api/devices');
                        const data = await resp.json();
                        if (data.success) {
                            this.devices = data.data || [];
                        }
                    } catch (err) {
                        console.error('Failed to load devices:', err);
                        this.devices = [];
                    }
                    this.renderDevices();
                },
                async loadPatterns() {
                    try {
                        const resp = await fetch('/api/patterns');
                        const data = await resp.json();
                        if (data.success) {
                            this.patterns = data.data || [];
                        }
                    } catch (err) {
                        console.error('Failed to load patterns:', err);
                        this.patterns = [];
                    }
                    this.renderPatterns();
                },
                renderDevices() {
                    const el = document.getElementById('devicesList');
                    if (this.devices.length === 0) {
                        el.innerHTML = '<p style="color: #6b7280;">No devices registered yet. <a href="/devices" style="color: #7e22ce; font-weight: 600;">Go to Devices page</a> to add one!</p>';
                        return;
                    }
                    el.innerHTML = this.devices.slice(0, 5).map(d => `
                        <div class="list-item">
                            <span>${d.name}</span>
                            <span class="badge ${d.isOnline ? 'badge-success' : 'badge-danger'}">
                                ${d.isOnline ? 'Online' : 'Offline'}
                            </span>
                        </div>
                    `).join('');
                },
                renderPatterns() {
                    const el = document.getElementById('patternsList');
                    if (this.patterns.length === 0) {
                        el.innerHTML = '<p style="color: #6b7280;">No patterns created yet. <a href="/patterns" style="color: #7e22ce; font-weight: 600;">Go to Patterns page</a> to create one!</p>';
                        return;
                    }
                    el.innerHTML = this.patterns.slice(0, 5).map(p => `
                        <div class="list-item">
                            <span>${p.name}</span>
                            <span class="badge">${p.type}</span>
                        </div>
                    `).join('');
                }
            }
        }
    </script>
</body>
</html>
