<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patterns - Candle Lights Controller</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <script src="/static/js/led-simulator.js"></script>
    <script src="/static/js/wled-preview.js"></script>
    <script src="/static/js/notifications.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand"><a href="/dashboard" style="color: inherit; text-decoration: none;">Candle Lights</a></div>
        <div class="nav-menu">
            <a href="/dashboard">Dashboard</a>
            <a href="/patterns" class="active">Patterns</a>
            <a href="/glowblaster">Glow Blaster</a>
            <a href="/devices">Devices</a>
            <a href="/settings">Settings</a>
            <a href="/auth/logout">Logout</a>
        </div>
    </nav>

    <div class="container" x-data="patternsPage()" x-init="init()">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h1 style="color: white;">Light Patterns</h1>
            <button @click="openCreateModal()" class="btn btn-primary">+ New Pattern</button>
        </div>

        <div x-show="isLoading" style="color: white; text-align: center; padding: 2rem;">
            Loading patterns...
        </div>

        <div x-show="!isLoading && patterns.length === 0" style="color: white; margin-top: 2rem; font-size: 1.1rem;">
            <p>No patterns created yet. Click "+ New Pattern" to get started!</p>
        </div>

        <div class="patterns-grid" x-show="!isLoading">
            <template x-for="pattern in patterns" :key="pattern.patternId">
                <div class="card pattern-card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3 x-text="pattern.name" style="margin: 0 0 0.25rem 0;"></h3>
                            <p x-text="pattern.description || ''" style="color: #6b7280; font-size: 0.85rem; margin: 0;"></p>
                        </div>
                        <span class="badge" x-text="getEffectName(pattern)" style="flex-shrink: 0;"></span>
                    </div>

                    <!-- Color preview -->
                    <div class="color-preview-multi" style="margin: 0.75rem 0; height: 24px; border-radius: 4px; overflow: hidden; display: flex;">
                        <template x-for="(color, idx) in (pattern.colors || [{r: pattern.red || 255, g: pattern.green || 100, b: pattern.blue || 0, percentage: 100}])" :key="idx">
                            <div :style="`background: rgb(${color.r}, ${color.g}, ${color.b}); flex: ${color.percentage || 100};`"></div>
                        </template>
                    </div>

                    <div style="display: flex; gap: 0.5rem; font-size: 0.8rem; color: #6b7280; margin-bottom: 0.75rem;">
                        <span>Brightness: <span x-text="pattern.brightness"></span></span>
                        <span>Speed: <span x-text="pattern.speed"></span></span>
                    </div>

                    <div class="buttons" style="display: flex; gap: 0.5rem;">
                        <button @click="simulatePattern(pattern)" class="btn btn-sm btn-primary">Preview</button>
                        <template x-if="pattern.category === 'glowblaster'">
                            <button @click="editInGlowBlaster(pattern)" class="btn btn-sm btn-secondary">Edit</button>
                        </template>
                        <template x-if="pattern.category !== 'glowblaster'">
                            <button @click="editPattern(pattern)" class="btn btn-sm btn-secondary">Edit</button>
                        </template>
                        <button @click="deletePattern(pattern.patternId)" class="btn btn-sm btn-danger">Delete</button>
                    </div>
                </div>
            </template>
        </div>

        <!-- Preview Modal -->
        <div x-show="showPreviewModal" class="modal" style="display: none;" @click.self="showPreviewModal = false">
            <div class="modal-content" style="max-width: 500px;">
                <h2 x-text="previewPattern?.name"></h2>
                <div id="previewContainer" style="margin: 1rem 0;"></div>
                <div style="text-align: center;">
                    <button @click="showPreviewModal = false" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Create/Edit Modal -->
        <div x-show="showModal" class="modal" style="display: none;" @click.self="closeModal()">
            <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 x-text="editingPattern ? 'Edit Pattern' : 'Create Pattern'" style="margin: 0;"></h2>
                    <div id="livePreviewContainer" style="width: 120px;"></div>
                </div>

                <form @submit.prevent="savePattern()">
                    <!-- Name -->
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Name</label>
                        <input type="text" x-model="form.name" required style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    </div>

                    <!-- Description -->
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Description <span style="font-weight: normal; color: #9ca3af;">(optional)</span></label>
                        <input type="text" x-model="form.description" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                    </div>

                    <!-- Effect -->
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Effect</label>
                        <select x-model="form.effectId" @change="onEffectChange()" style="width: 100%; padding: 0.5rem; border: 1px solid #e5e7eb; border-radius: 6px;">
                            <template x-for="effect in effects" :key="effect.id">
                                <option :value="effect.id" x-text="effect.name + ' - ' + effect.description"></option>
                            </template>
                        </select>
                    </div>

                    <!-- Colors Section -->
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <label style="font-weight: 500;">Colors</label>
                            <button type="button" @click="addColor()" x-show="form.colors.length < (selectedEffect?.maxColors || 3)" class="btn btn-sm" style="padding: 0.25rem 0.5rem;">+ Add Color</button>
                        </div>

                        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                            <template x-for="(color, idx) in form.colors" :key="idx">
                                <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: #f9fafb; border-radius: 6px;">
                                    <input type="color" :value="rgbToHex(color.r, color.g, color.b)" @input="updateColorFromPicker(idx, $event.target.value)" style="width: 40px; height: 32px; border: none; cursor: pointer;">
                                    <div style="display: flex; gap: 0.25rem; flex: 1;">
                                        <input type="number" x-model.number="color.r" @input="updatePreview()" min="0" max="255" style="width: 50px; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="R">
                                        <input type="number" x-model.number="color.g" @input="updatePreview()" min="0" max="255" style="width: 50px; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="G">
                                        <input type="number" x-model.number="color.b" @input="updatePreview()" min="0" max="255" style="width: 50px; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px;" placeholder="B">
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 0.25rem;">
                                        <input type="range" x-model.number="color.percentage" @input="normalizePercentages(idx)" min="1" max="100" style="width: 60px;">
                                        <span style="min-width: 32px; text-align: right; font-size: 0.8rem;" x-text="color.percentage + '%'"></span>
                                    </div>
                                    <button type="button" @click="removeColor(idx)" x-show="form.colors.length > 1" style="padding: 0.25rem 0.5rem; background: #fee2e2; color: #dc2626; border: none; border-radius: 4px; cursor: pointer;">x</button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Brightness -->
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Brightness</label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="range" x-model.number="form.brightness" @input="updatePreview()" min="0" max="255" style="flex: 1;">
                            <input type="number" x-model.number="form.brightness" @input="updatePreview()" min="0" max="255" style="width: 60px; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Speed (sx) -->
                    <div style="margin-bottom: 1rem;" x-show="selectedEffect?.hasSpeed">
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">
                            Speed <span style="font-weight: normal; color: #6b7280;" x-text="selectedEffect?.speedDesc ? '(' + selectedEffect.speedDesc + ')' : ''"></span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="range" x-model.number="form.speed" @input="updatePreview()" min="0" max="255" style="flex: 1;">
                            <input type="number" x-model.number="form.speed" @input="updatePreview()" min="0" max="255" style="width: 60px; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Intensity (ix) -->
                    <div style="margin-bottom: 1rem;" x-show="selectedEffect?.hasIntensity">
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">
                            Intensity <span style="font-weight: normal; color: #6b7280;" x-text="selectedEffect?.intensDesc ? '(' + selectedEffect.intensDesc + ')' : ''"></span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="range" x-model.number="form.intensity" @input="updatePreview()" min="0" max="255" style="flex: 1;">
                            <input type="number" x-model.number="form.intensity" @input="updatePreview()" min="0" max="255" style="width: 60px; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Custom 1 (c1) -->
                    <div style="margin-bottom: 1rem;" x-show="selectedEffect?.hasCustom1">
                        <label style="display: block; margin-bottom: 0.25rem; font-weight: 500;">
                            <span x-text="selectedEffect?.custom1Desc || 'Custom 1'"></span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="range" x-model.number="form.custom1" @input="updatePreview()" min="0" max="255" style="flex: 1;">
                            <input type="number" x-model.number="form.custom1" @input="updatePreview()" min="0" max="255" style="width: 60px; padding: 0.25rem; text-align: center; border: 1px solid #e5e7eb; border-radius: 4px;">
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                        <button type="button" @click="closeModal()" class="btn btn-secondary">Cancel</button>
                        <button type="submit" class="btn btn-primary" :disabled="isSaving">
                            <span x-show="!isSaving" x-text="editingPattern ? 'Save Changes' : 'Create Pattern'"></span>
                            <span x-show="isSaving">Saving...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="/static/js/patterns.js"></script>
</body>
</html>
